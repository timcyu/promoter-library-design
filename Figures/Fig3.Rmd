---
title: "Fig3"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
setwd("~/Desktop/induce_library/figs/")

```

```{r, include=FALSE}

library(viridis)
library(plyr)
library("ggplot2")
library("dplyr")
library("tidyr")
library("ggjoy")
library("reshape2")
require(cowplot)
library('RInside')
library("stringr")
require(forcats)
library("colorspace")
#install.packages("scales")
library(scales)


```

```{r}
induce_exp <- read.table("induce_library/processed_data/induce_exp.txt", header = T)

induce_distal <- subset(induce_exp, grepl("DISTAL", induce_exp$name)) %>% separate(col = 'name', into = c("Library", "Distal", "Offset", "Min_35", "Core", "Min_10"), sep = "-", remove = F)

induce_distal$Min_35 <- with(induce_distal, reorder(Min_35, ratio, median))
induce_distal$Min_10 <- with(induce_distal, reorder(Min_10, ratio, median))
induce_distal$Core <- with(induce_distal, reorder(Core, ratio, median))
induce_distal$Distal <- with(induce_distal, reorder(Distal, ratio, median))

induce_steric <- subset(induce_exp, grepl("STERIC", induce_exp$name)) %>% 
  separate(col = 'name', into = c("Library", "Loop_Distance", "UP", "Core", "Extended_Min_10", "Min_10", "Proximal"), sep = "-", remove = F)

induce_steric$Min_10 <- with(induce_steric, reorder(Min_10, ratio, median))
induce_steric$Core <- with(induce_steric, reorder(Core, ratio, median))
induce_steric$Proximal <- with(induce_steric, reorder(Proximal, ratio, median))

induce_distal$Core <- gsub("_core", "", induce_distal$Core)

induce_multiple <- subset(induce_exp, grepl("MULTIPLE", induce_exp$name)) %>% separate(col = 'name', into = c("Library", "Distal_left", "Distal_right", "Min_35", "Min_10", "Proximal"), sep = "-", remove = F) %>% mutate(induction = ratio/normalized_RNA_exp_UnInduced_12)

```

```{r}
pal <- choose_palette()

```

```{r}
# filter various libraries for good promoters
co <- induce_combo %>% filter((Proximal == 'lacO1' | Proximal == 'lacO2' | Proximal == 'lacO3' | Proximal == 'lacOsym' | Proximal == 'lacOscram') &
(Distal == 'lacO1' | Distal == 'lacO2' | Distal == 'lacO3' | Distal == 'lacOsym' | Distal == 'lacOscram')) %>% filter(Min_10 == 'minus10cons' & Min_35 == 'minus35cons')

di <- induce_distal %>%
  filter(Min_10 == 'minus10cons' & Min_35 == 'minus35cons') %>%
  group_by(Offset) %>%
  mutate(mean_ind = mean(ratio/normalized_RNA_exp_UnInduced_12)) %>%
  ungroup() %>%
  filter(mean_ind == max(mean_ind)) 

st <- filter(induce_steric, Min_10 == 'minus10cons', Loop_Distance == 55, UP == 'up_326x' | UP == 'up136x', Extended_Min_10 == 'ext_min10')

mu <- filter(induce_multiple, Min_10 == 'minus10cons', Min_35 == 'minus35cons')

# FIGURE 3B: Combinatorial Induction:Noise of Pcombo, Pdistal, and Psteric next to one another
a <- ggplot(di, aes(x = Core, y = Distal)) + geom_tile(aes(fill = log10(ratio/normalized_RNA_exp_UnInduced_12))) +  
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10), axis.text.y = element_text(size = 10)) +
  scale_fill_viridis(name = 'Induction:Noise', limits = c(-2.2, 1.6)) +
  scale_y_discrete(limits=c("lacOscram", "lacO3", 'lacO2', 'lacO1', 'lacOsym')) +
  scale_x_discrete(limits=c('lacOscram', 'lacO3', 'lacO2', 'lacO1', 'lacOsym')) +

#  labs(title = 'Combinatorial UnInduced Expression of Core and Distal Operator Sites with Consensus -10/-35', x = 'Core', y = 'Distal', size = 30) +
 theme(panel.background = element_rect(fill = "gray40"))

b <- ggplot(co, aes(x = Proximal, y = Distal)) + geom_tile(aes(fill = log10(ratio/normalized_RNA_exp_UnInduced_12))) + theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10), axis.text.y = element_text(size = 10)) +
  scale_fill_viridis(name = 'Induction:Noise', limits = c(-2.2, 1.6)) + scale_y_discrete(limits=c("lacOscram", "lacO3", 'lacO2', 'lacO1', 'lacOsym')) +
scale_x_discrete(limits=c("lacOscram", "lacO3", 'lacO2', 'lacO1', 'lacOsym')) + 
theme(panel.background = element_rect(fill = "gray40"))
#  labs(title = 'Combinatorial UnInduced Expression of Core and Distal Operator Sites with Consensus -10/-35', x = 'Proximal', y = 'Distal', size = 30) +
#  

c <- ggplot(st, aes(x = Core, y = Proximal)) + geom_tile(aes(fill = log10(ratio/normalized_RNA_exp_UnInduced_12))) +  
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10), axis.text.y = element_text(size = 10)) +
  scale_fill_viridis(name = 'Induction:Noise', limits = c(-2.2, 1.6)) +
  scale_y_discrete(limits=c("lacOscram", "lacO3", 'lacO2', 'lacO1', 'lacOsym')) +
  scale_x_discrete(limits=c("lacOscram", "lacO3", 'lacO2', 'lacO1', 'lacOsym')) +
#  labs(title = 'Combinatorial UnInduced Expression of Core and Distal Operator Sites with Consensus -10/-35', x = 'Core', y = 'Proximal', size = 30) +
  theme(panel.background = element_rect(fill = "gray40"))

plot_grid(a,b,c, ncol = 3) 
```

```{r}
#Comparing ratio/basal vs basal across the filtered 3 libraries
#combine dataframes
stack_df <- function(a, b, c) {
  temp <- bind_rows(a,b)
  temp <- bind_rows(temp, c)
  return(temp)
}

basal_exp <- stack_df(co, di, st)

basal_exp <- bind_rows(basal_exp, mu)

pal3 <- c('#EE2524', '#EBCC2A', '#3B9BB3', '#5D478B')

ggplot(basal_exp, aes(x=normalized_RNA_exp_UnInduced_12, y=ratio)) + geom_point(aes(color=Library), alpha = .9, size = 2.5) + scale_color_manual(values = pal3) +
annotation_logticks() + scale_x_log10(breaks = c(1,10,100)) + geom_smooth(aes(color = Library), method = 'gam', formula = y ~ x, se = FALSE) + 
  scale_y_log10(breaks = c(1,10,100)) + xlab('Basal Expression') + ylab('Induction Ratio') + labs(title = 'Induction Ratio vs. Basal Expression')
ggsave('Fig_3B.pdf', width = 10, height = 8)


```

```{r}

pal3 <- c('#EE2524', '#EBCC2A', '#3B9BB3', '#5D478B')
a <- ggplot(NULL, aes(x = "", y = normalized_RNA_exp_UnInduced_12)) +
  geom_boxplot(data = st, aes(x = "Steric", fill = Library)) + 
  geom_boxplot(data = co, aes(x = "Combo", fill = Library)) +
  geom_boxplot(data = di, aes(x = "Distal", fill = Library)) +
  geom_boxplot(data = mu, aes(x = "Multiple", fill = Library)) + 
  scale_fill_manual(values = pal3) +
  ylab('Basal Expression') + xlab('Promoter Architecture') + labs(title = 'Variation in basal expression levels \n across different promoter architectures') + scale_y_log10() + annotation_logticks(sides = "l") + scale_x_discrete(limits = c("Distal", "Combo", "Multiple", "Steric")) + theme(axis.text.x = element_text(angle = 45, hjust = 1, size =10)) 

b <- ggplot(NULL, aes(x = "", y = ratio/normalized_RNA_exp_UnInduced_12)) +
  geom_boxplot(data = st, aes(x = "Steric", fill = Library)) + 
  geom_boxplot(data = co, aes(x = "Combo", fill = Library)) +
  geom_boxplot(data = di, aes(x = "Distal", fill = Library)) +
  geom_boxplot(data = mu, aes(x = "Multiple", fill = Library)) +
  scale_fill_manual(values = pal3) +
  ylab('Induction:Noise') + xlab('Promoter Architecture') + labs(title = 'Variation in Induction:Noise levels \n across different promoter architectures') + scale_y_log10() + annotation_logticks(sides = "l") + scale_x_discrete(limits = c("Distal", "Combo", "Multiple", "Steric")) + theme(axis.text.x = element_text(angle = 45, hjust = 1, size =10)) 

plot_grid(a,b)
ggsave('Fig_3C.pdf', width = 20, height = 8)

```





```{r}
up_326x_ext_10 <- filter(induce_steric, Loop_Distance == 55, UP == 'up_326x', Extended_Min_10 == 'ext_min10') %>% mutate(category = 'up_326x_ext_10')
up_326x_ext_UV5 <- filter(induce_steric, Loop_Distance == 55, UP == 'up_326x', Extended_Min_10 == 'ext_UV5') %>% mutate(category = 'up_326x_ext_UV5')
no_up_ext_10 <- filter(induce_steric, Loop_Distance == 55, UP == 'no_up', Extended_Min_10 == 'ext_min10') %>% mutate(category = 'no_up_ext_10')
no_up_ext_UV5 <- filter(induce_steric, Loop_Distance == 55, UP == 'no_up', Extended_Min_10 == 'ext_UV5') %>% mutate(category = 'no_up_ext_UV5')

temp1 <- rbind(up_326x_ext_10, up_326x_ext_UV5)
temp2 <- rbind(temp1, no_up_ext_10)
steric_box <- rbind(temp2, no_up_ext_UV5)

rm(temp1, temp2, up_326x_ext_10, up_326x_ext_UV5, no_up_ext_10, no_up_ext_UV5)

library(RColorBrewer)

pal4 <- brewer.pal(n=4, name ='RdBu')

gg1 <- steric_box %>%
  ggplot(., aes(fill = Min_10, y = normalized_RNA_exp_UnInduced_12, x = category)) +
  geom_bar(position = "dodge", stat = 'identity') + scale_x_discrete(limits = c('no_up_ext_UV5', 'up_326x_ext_UV5', 'no_up_ext_10', 'up_326x_ext_10')) +   scale_fill_manual(values = pal4) + labs(y = 'Basal Expression', x = 'Regulatory element combination') + theme(axis.text.x = element_text(angle = 45, hjust = 1, size =10))
                  
gg2 <- steric_box %>%
  ggplot(., aes(fill = Min_10, y = ratio, x = category)) +
  geom_bar(position = "dodge", stat = 'identity') + scale_x_discrete(limits = c('no_up_ext_UV5', 'up_326x_ext_UV5', 'no_up_ext_10', 'up_326x_ext_10')) +   scale_fill_manual(values = pal4) + labs(y = 'Induction Ratio', x = 'Regulatory element combination') + theme(axis.text.x = element_text(angle = 45, hjust = 1, size =10))                                                                            
gg <- plot_grid(gg1, gg2)
title <- ggdraw() + draw_label("Optimizing Proximal-Core (STERIC) promoters by swapping out UP and extended -10 elements", fontface='bold')
plot_grid(title, gg, ncol = 1, rel_heights=c(0.1, 1))
ggsave('Fig_3D.pdf', width = 20, height = 8)                                                                                                                                                                                                
                                                                                                                                                                                                   
                                                                                                                                                                                                   #title = 'Optimizing Psteric promoters by swapping out UP and extended -10 elements')

```




```{r message=FALSE, warning=FALSE}
# DISTAL Offset figure

pal5 <- brewer.pal(n=5, name ='Dark2')

induce_distal %>%
  filter(Min_10 == 'minus10cons' & Min_35 == 'minus35cons') %>%
  filter(Core == 'lacOsym') %>%
    ggplot(aes(x = as.integer(Offset), y = log2(normalized_RNA_exp_UnInduced_12))) +  geom_smooth(span = 0.4, aes(color = Distal)) + scale_color_manual(values = pal5) + scale_x_continuous(breaks= pretty_breaks()) + geom_point(aes(color = Distal), size = 3) + labs(x = 'Offset', y = 'Basal Expression', title = 'Basal expression of Core-Distal (DISTAL) Promoters \n with consensus -10/-35 and core Osym')
ggsave('Fig_3E.pdf', width = 10, height = 8)

```






```{r}

ggplot(induce_steric, aes(normalized_RNA_exp_UnInduced_12, normalized_RNA_exp_Induced_12)) +
geom_point(alpha = .4) + geom_smooth(method='gam', color = 'dodgerblue2') + annotation_logticks() + scale_x_log10(breaks = c(1,10,100)) + scale_y_log10(breaks = c(1,10,100)) + xlab('Uninduced expression') + ylab('Induced expression') + labs(title = 'Comparing promoter expression between induced and uninduced') +  geom_point(data=filt_ind_steric, aes(normalized_RNA_exp_UnInduced_12, normalized_RNA_exp_Induced_12), color = "firebrick1", alpha = .8, size = 3)


```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
